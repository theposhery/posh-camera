<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">

<!--
Camera element that allows you to pick sources and get video frame data

##### Example

    <posh-camera></posh-camera>

@element posh-camera
@blurb Camera element that allows you to pick sources and get video frame data
@status alpha
-->
<polymer-element name="posh-camera" on-click="{{toggleMenu}}" attributes="currentSource">

  <template>

    <link rel="stylesheet" href="posh-camera.css" />
    <content>
      <div>
        <video id="vid" autoplay="true"></video>

        <!-- invisible canvas element to route video to and extract data from -->
        <canvas id="canvas"></canvas>

        <div id="sourcesmenu">
          <paper-button raised on-tap="{{refreshSourcesClick}}">Refresh Video Sources</paper-button>
          <template repeat="{{ src in videoSources }}">
            <paper-checkbox data-videoSourceId="{{src.id}}" on-change="{{onVideoSourceSelect}}"></paper-checkbox> {{src.label}}
          </template>
          </ul>
        </div>
      </div>

    </content>

  </template>

  <script>

    var self;

    Polymer({

      /**
       * video sources list
       *
       * @attribute sources
       * @type array
       * @default []
       */
      videoSources: [],

      /**
       * current video source used
       * @attribute currentSource
       * @type string
       * @default none
       */
      currentSource: "none",

      /**
       * on component ready
       *
       */
      ready: function() {
        self = this;

        this.canvasctx = this.$.canvas.getContext("2d");
        this.refreshVideoSources( function(sources) {
          self.parseSourceAttribute(this.currentSource);
        });
      },

      /**
       * toggle sources menu off and on
       * @method toggleMenu
       */
      toggleMenu: function() {
        var cssprops = window.getComputedStyle(this.$.sourcesmenu);
        if (cssprops.display == "none") {
          this.$.sourcesmenu.style.display = "block";
        } else {
          this.$.sourcesmenu.style.display = "none";
        }
      },

      /**
       * set video source by index
       * @method setSourceByIndex
       * @param index
       */
      setSourceByIndex: function(indx) {
        if (indx >= self.videoSources.length) { console.log("Video Source Index does not exist"); return; }
        this.setSourceById(self.videoSources[indx].id);
      },

      /**
       * set video source by id
       *
       * @method setSourceById
       * @param video id
       */
      setSourceById: function(id) {
        // todo: update checkbox to indicate what's being used
        navigator.webkitGetUserMedia({ video: {optional: [{sourceId: id }]}},
          self.onVideoStream, function() {});
      },

      /**
       * get image data for current frame
       *
       * @method getCurrentFrameData
       * @param {boolean} data mode (binary or base64)
       * @return {object} image data
       */
      getCurrentFrameData: function(mode) {
        if (!mode) { mode = "binary"; }

        this.$.canvas.setAttribute('width', this.$.vid.offsetWidth);
        this.$.canvas.setAttribute('height', this.$.vid.offsetHeight);
        this.canvasctx.drawImage(this.$.vid,0,0, this.$.vid.offsetWidth,this.$.vid.offsetHeight);
        var data = this.$.canvas.toDataURL("image/png");

        if (mode == "binary") {
          var base64Data = data.replace('data:image/png;base64', "");
          var binaryData =  new Buffer(base64Data, 'base64');
          data = binaryData;
        }
        return data;
      },

      /**
       * save current frame to file
       *
       * @method saveCurrentFrameToFile
       * @param file path
       * @param image type
       */
      saveCurrentFrameToFile: function(pth) {
        var data = this.getCurrentFrameData("base64").toString('binary');
        var fs = require('fs');
        fs.writeFileSync(pth, binaryData, 'binary' );
      },

      /**
       * refresh sources click handler
       *
       * @param {object} event
       */
      refreshSourcesClick: function(e) {
        self.refreshVideoSources();
      },

      /**
       * get video sources
       *
       * @method refreshVideoSources
       * @param {object} callback
       */
      refreshVideoSources: function(cb) {
        this.videoSources = [];
        MediaStreamTrack.getSources( function(sources) {
          self.onVideoSources(sources);
          if (cb) { cb.apply(self, [sources]); }
        });
      },

      /**
       * on video sources callback
       *
       * @param {array} sources found
       */
      onVideoSources: function(sources) {
        var storageIndex = 0;
        for (var i=0; i < sources.length; i++) {
          if (sources[i].kind == 'video') {
            var label = sources[i].label;
            if (label == "") { label = "video " + Number(storageIndex+1); }
            sources[storageIndex] = sources[i].id;
            self.videoSources.push({ label: label, id: sources[i].id });
            storageIndex++;
          }
        }
      },

      /**
       * on video source selection callback
       *
       * @param {object} event
       * @param {object} detail
       * @parma {object} sender
       */
        onVideoSourceSelect: function(e, detail, sender) {
          this.setSourceById(sender.getAttribute('data-videoSourceId'));
        },

        /**
        * on video source stream
        *
        * @param stream
        */
        onVideoStream: function(stream) {
          self.$.vid.src = webkitURL.createObjectURL(stream);
        },

        /**
         * parse source attribute
         * @param {string} source
         * @return {object} source
         */
        parseSourceAttribute: function(src) {
          if (parseInt(src)) {
            this.setSourceByIndex(parseInt(src));
          }

          // Todo: allow other ways of setting the source (by ID? by name?)
        }
    });

  </script>

</polymer-element>
